language: java
sudo: false
dist: trusty

jobs:
  include:
  - stage: test
    install: skip
    before_script:
    - export PUB_VERSION=$(./gradlew currentVersion -q)
    - echo 'Check version and tag'
    - git tag | grep "^${PUB_VERSION}$"
    script:
    - echo $GPG_KEY | base64 --decode > ${SIGNING_SECRETKEYRINGFILE}
    - ./gradlew -Dorg.gradle.project.signing.keyId="$SIGNING_KEYID" -Dorg.gradle.project.signing.password="$SIGNING_PASSWORD" -Dorg.gradle.project.signing.secretKeyRingFile="$SIGNING_SECRETKEYRINGFILE" check build
    - ./gradlew -Dorg.gradle.project.signing.keyId="$SIGNING_KEYID" -Dorg.gradle.project.signing.password="$SIGNING_PASSWORD" -Dorg.gradle.project.signing.secretKeyRingFile="$SIGNING_SECRETKEYRINGFILE" jacocoTestReport coveralls

  - stage: snapshot
    install: skip
    env:
    - VERSION_SCOPE='-SNAPSHOT'
    script:
    - echo $GPG_KEY | base64 --decode > ${SIGNING_SECRETKEYRINGFILE}
    - export PUB_VERSION=$(./gradlew currentVersion -q)
    - ./gradlew -Dorg.gradle.project.signing.keyId="$SIGNING_KEYID" -Dorg.gradle.project.signing.password="$SIGNING_PASSWORD" -Dorg.gradle.project.signing.secretKeyRingFile="$SIGNING_SECRETKEYRINGFILE" build publishToNexus -x check

  - stage: release
    install: skip
    env:
    - VERSION_SCOPE=''
    script:
    - echo $GPG_KEY | base64 --decode > ${SIGNING_SECRETKEYRINGFILE}
    - export PUB_VERSION=$(./gradlew currentVersion -q)
    - ./gradlew -Dorg.gradle.project.signing.keyId="$SIGNING_KEYID" -Dorg.gradle.project.signing.password="$SIGNING_PASSWORD" -Dorg.gradle.project.signing.secretKeyRingFile="$SIGNING_SECRETKEYRINGFILE" build publishToNexus -x check && git config --global user.email "travis@travis-ci.org" && git config --global user.name "Travis CI" && git tag ${PUB_VERSION} -a -m 'CI Release' && git push -q "https://${GH_TOKEN}@github.com/leeonky/java-builder.git" --tags

stages:
- name: test
  if: branch IN (master, hotfix, release)
- name: snapshot
  if: branch IN (master, hotfix)
- name: release
  if: branch = release
